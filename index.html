<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PosologiaCerta • Beta 2.1 (autoload)</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#0e1930;
      --txt:#e5e7eb; --muted:#9aa6b2; --brand:#22c55e; --acc:#38bdf8;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 56px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;
      background:linear-gradient(145deg,var(--brand),var(--acc));box-shadow:var(--shadow)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #25425d;color:#a3c6ff;font-size:12px}
    h1{margin:0;font-size:20px}
    .panel{background:linear-gradient(180deg,#121a2a,#0c1424);border:1px solid #24324a;border-radius:var(--radius);box-shadow:var(--shadow)}
    .searchbar{display:flex;gap:10px;padding:12px;border-bottom:1px dashed #27405e}
    .searchbar input{flex:1;background:#0b1528;color:var(--txt);border:1px solid #294463;border-radius:12px;padding:12px 14px}
    .btn{border:1px solid #2a4b6b;background:#0b1528;color:var(--txt);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(145deg,var(--acc),var(--brand));color:#001b0e;border:0}
    .tools{display:flex;flex-wrap:wrap;gap:8px;padding:10px 12px}
    .chip{padding:8px 12px;border-radius:999px;background:#0b1528;border:1px solid #2a4b6b;color:#a9b4c2;cursor:pointer}
    .chip.active{background:linear-gradient(145deg,#0ea5e9,#22c55e);color:#001b0e;border:0;font-weight:700}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    @media (max-width: 960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #27405e;border-radius:var(--radius);padding:16px}
    .result-item{display:grid;grid-template-columns:1fr auto;gap:10px;padding:12px 0;border-bottom:1px dashed #2b4562}
    .result-item:last-child{border-bottom:0}
    .title{font-weight:800}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#cbd5e1}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .thin{flex:0 0 100px}
    input,select,textarea{background:#0b1528;color:var(--txt);border:1px solid #2a4b6b;border-radius:12px;padding:10px 12px}
    .actions{display:flex;gap:8px}
    .actions button{padding:10px 12px;border-radius:12px;border:1px solid #2a4b6b;background:#0b1528;color:var(--txt);cursor:pointer}
    .actions button.primary{background:linear-gradient(145deg,var(--acc),var(--brand));color:#001b0e;border:0}
    .notice{background:#0b1528;border:1px dashed #3a5f84;border-radius:12px;padding:10px 12px;color:#bcd0e4;font-size:13px}
    footer{margin-top:24px;color:#92a2b3;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M5 12a7 7 0 0114 0v1h1a2 2 0 010 4h-1.126A4.002 4.002 0 0115 21h-2a4 4 0 01-3.874-3H8a3 3 0 110-6h.126A7.002 7.002 0 015 12z"/></svg>
        </div>
        <div>
          <h1>PosologiaCerta <span class="pill">beta 2.1</span></h1>
          <div class="muted" id="ds-tag">Autoload + PWA</div>
        </div>
      </div>
      <div class="actions">
        <button id="btn-install" class="btn">Instalar (PWA)</button>
      </div>
    </header>

    <section class="panel">
      <div class="searchbar">
        <input id="q" placeholder="Busque por medicamento, patologia ou protocolo (ex.: amoxicilina, otite, IAM)…">
        <button id="btn-search" class="btn primary">Buscar</button>
        <button id="btn-clear" class="btn">Limpar</button>
      </div>
      <div class="tools">
        <span class="chip active" data-mode="adulto">Adulto</span>
        <span class="chip" data-mode="pediatria">Pediatria</span>
        <span class="chip" data-mode="gestante">Gestante</span>
      </div>
    </section>

    <div class="grid">
      <section class="card" id="results">
        <div class="notice" id="loading">Carregando base…</div>
      </section>

      <aside class="card">
        <div class="row">
          <div class="muted">Bundle:</div>
          <div id="bundle-meta" class="pill">—</div>
        </div>
        <hr style="border:none;border-top:1px dashed #2b4562;margin:12px 0">
        <h3 style="margin:0 0 8px">Calculadora pediátrica</h3>
        <div class="row">
          <input id="peso" type="number" step="0.1" placeholder="Peso (kg)">
          <input id="mgkg" type="number" step="0.1" placeholder="mg/kg">
          <input id="freq" type="number" step="1" placeholder="x/dia">
        </div>
        <div class="row" style="margin-top:8px">
          <input id="conc" type="number" step="0.1" placeholder="Concentração (mg/mL ou mg/cp)">
          <select id="forma" class="thin">
            <option value="mL">mL</option>
            <option value="cp">comprimidos</option>
            <option value="gota">gotas</option>
          </select>
          <button id="btn-calc" class="btn primary thin">Calcular</button>
        </div>
        <pre id="calc-out" class="mono" style="white-space:pre-wrap;margin-top:8px"></pre>
      </aside>
    </div>

    <footer>
      <p><b>Disclaimer:</b> apoio rápido para profissionais de saúde. Ajuste à clínica, TFG/IH e interações.</p>
    </footer>
  </div>

<script>
let DB = [];
const state = { modo:'adulto', query:'' };
function qs(sel){ return document.querySelector(sel); }
function el(tag, props={}, children=[]){
  const e = document.createElement(tag);
  Object.assign(e, props);
  if(props.className) e.setAttribute('class', props.className);
  children.forEach(c => e.appendChild(typeof c==='string'? document.createTextNode(c) : c));
  return e;
}
function updateMeta(meta){
  const tag = qs('#bundle-meta');
  const dsTag = qs('#ds-tag');
  if(meta && meta.versao){
    tag.textContent = `${meta.nome || 'Bundle'} ${meta.versao} • ${(DB||[]).length} fármacos`;
  } else {
    tag.textContent = `• ${(DB||[]).length} fármacos`;
  }
  dsTag.textContent = 'PosologiaCerta Bundle ' + (meta?.versao || '—') + ' • ' + (DB||[]).length + ' fármacos';
}
function renderResults(list){
  const root = qs('#results');
  root.innerHTML = '';
  if(!list || !list.length){
    root.appendChild(el('div', {className:'notice', innerText:'Nenhum resultado. Busque por nome, princípio ativo ou patologia.'}));
    return;
  }
  list.forEach(item => {
    const faixa = (item.faixas||{})[state.modo] || {};
    const head = el('div', {className:'title', innerText: `${item.nome} • ${state.modo}`});
    const sub = el('div', {className:'muted mono', innerText: `${item.principioAtivo || ''}`});
    const body = el('div', {innerHTML: `
      <div><b>Indicações:</b> ${(item.indicacoes||[]).join(', ') || '-'}</div>
      <div><b>Dose:</b> ${faixa.dose || faixa.nota || '-'}</div>
      ${faixa.duracao ? `<div><b>Duração:</b> ${faixa.duracao}</div>` : ''}
      ${faixa.max ? `<div><b>Máximo:</b> ${faixa.max}</div>` : ''}
      ${item.ajustes ? `<div><b>Ajustes:</b> Renal: ${item.ajustes.renal||'-'} • Hepática: ${item.ajustes.hepatica||'-'}</div>` : ''}
      ${item.obs ? `<div class="muted">Obs.: ${item.obs}</div>` : ''}
    `});
    const row = el('div', {className:'result-item'}, [el('div',{},[head,sub,body])]);
    root.appendChild(row);
  });
}
function filterCurrent(list){
  const q = (state.query||'').toLowerCase();
  if(!q) return list;
  return list.filter(x =>
    x.nome?.toLowerCase().includes(q) ||
    x.principioAtivo?.toLowerCase().includes(q) ||
    (x.sinonimos||[]).some(s => s.toLowerCase().includes(q)) ||
    (x.indicacoes||[]).some(d => d.toLowerCase().includes(q))
  );
}
async function autoload(){
  const candidates = [
    "./posologiacerta-bundle-v0.10-beta2-BR.json",
    "./posologiacerta-bundle-v0.9-beta-BR%20(1).json",
    "./posologiacerta-bundle-v0.9-beta-BR.json"
  ];
  for(const name of candidates){
    try{
      const url = `${name}?t=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) continue;
      const data = await res.json();
      const meds = data?.medicamentos || data;
      if(!Array.isArray(meds)) throw new Error('Formato inesperado do bundle');
      DB = meds;
      updateMeta(data?.meta);
      renderResults(DB);
      return;
    }catch(err){
      console.warn('Falha ao carregar', name, err);
    }
  }
  qs('#results').innerHTML = "<div class='notice'>Falha ao carregar a base. Atualize com Ctrl+F5 ou tente novamente.</div>";
}
function hookUI(){
  qs('#btn-search').addEventListener('click', ()=>{ state.query = qs('#q').value.trim(); renderResults(filterCurrent(DB)); });
  qs('#btn-clear').addEventListener('click', ()=>{ qs('#q').value=''; state.query=''; renderResults(DB); });
  qs('#q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ state.query = qs('#q').value.trim(); renderResults(filterCurrent(DB)); } });
  document.querySelectorAll('.chip[data-mode]').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      document.querySelectorAll('.chip[data-mode]').forEach(c=> c.classList.remove('active'));
      ch.classList.add('active'); state.modo = ch.dataset.mode;
      renderResults(filterCurrent(DB));
    });
  });
  qs('#btn-calc').addEventListener('click', ()=>{
    const peso = parseFloat(qs('#peso').value);
    const mgkg = parseFloat(qs('#mgkg').value);
    const freq = parseFloat(qs('#freq').value||1);
    const conc = parseFloat(qs('#conc').value);
    const forma = qs('#forma').value;
    if(!(peso>0 && mgkg>0)){ qs('#calc-out').textContent='Preencha peso e mg/kg.'; return; }
    const mgDose = peso*mgkg;
    let conv = ''; 
    if(conc>0){
      if(forma==='mL'){ conv = (mgDose/conc).toFixed(2)+' mL'; }
      else if(forma==='cp'){ conv = (mgDose/conc).toFixed(2)+' cp'; }
      else if(forma==='gota'){ conv = ((mgDose/conc)/0.05).toFixed(0)+' gotas'; }
    }
    qs('#calc-out').textContent = `Dose: ${mgDose.toFixed(0)} mg por tomada (${freq}x/dia)
${conv?('≈ '+conv):'(informe a concentração para converter)'}`;
  });
}
document.addEventListener('DOMContentLoaded', async ()=>{
  if('serviceWorker' in navigator){
    try{ await navigator.serviceWorker.register('./sw.js?v=pc-v3'); }catch(e){}
  }
  hookUI();
  await autoload();
});
</script>
</body>
</html>
