<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>PosologiaCerta • Beta 2.1 <script>
// ... deixe o resto do arquivo como está

async function autoload(){
  // ordem de tentativa (o 1º é o beta2):
  const candidates = [
    "./posologiacerta-bundle-v0.10-beta2-BR.json",
    "./posologiacerta-bundle-v0.9-beta-BR%20(1).json",
    "./posologiacerta-bundle-v0.9-beta-BR.json"
  ];

  for (const name of candidates) {
    try {
      // cache-buster + no-store para evitar SW/cache antigo
      const url = `${name}?t=${Date.now()}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) continue;

      const data = await res.json();
      // carrega a lista de medicamentos na memória:
      DB.splice(0, DB.length, ...(data.medicamentos || data || []));
      updateDsMeta();
      // já renderiza algo ao abrir:
      renderResults(filterCurrent(DB));
      return;
    } catch (err) {
      console.warn("Falha ao tentar carregar:", name, err);
    }
  }

  // fallback amigável
  document.querySelector("#results").innerHTML =
    "<div class='notice'>Falha ao carregar a base. Recarregue com Ctrl+F5 ou tente novamente.</div>";
}

// chame o autoload no onload, se ainda não existia a chamada:
document.addEventListener('DOMContentLoaded', autoload);
</script>
</title>
<link rel="manifest" href="manifest.json"><meta name="theme-color" content="#0ea5e9">
<style>
:root{--bg:#0f172a;--txt:#e5e7eb;--mut:#94a3b8;--brand:#22c55e;--acc:#0ea5e9;--radius:14px}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:24px 16px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--acc),var(--brand));display:grid;place-items:center}
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.25);border-radius:var(--radius);padding:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,select,button,textarea{background:#0b1227;color:var(--txt);border:1px solid rgba(148,163,184,.3);border-radius:10px;padding:10px 12px}
button.primary{background:linear-gradient(135deg,var(--acc),var(--brand));border:0;color:#071f14;font-weight:700}
.chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);cursor:pointer;color:var(--mut)}
.chip.active{background:linear-gradient(135deg,var(--acc),var(--brand));color:#001b0e;border:0;font-weight:800}
.grid{display:grid;grid-template-columns:1.4fr .6fr;gap:16px}@media (max-width:980px){.grid{grid-template-columns:1fr}}
.result{padding:10px 0;border-bottom:1px dashed rgba(148,163,184,.25)}
.mut{color:var(--mut)} .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.35)}
.section-title{margin:6px 0}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="row"><div class="logo">PC</div><div><h2 style="margin:0">PosologiaCerta <span class="mut">• beta 2.1</span></h2><small class="mut">Autoload + PWA</small></div></div>
  <div class="row"><button id="btn-install">Instalar (PWA)</button><span id="ds" class="mut"></span></div>
</header>

<section class="card" style="margin-top:10px">
  <div class="row">
    <input id="q" placeholder="Busque por medicamento, patologia ou protocolo (ex.: amoxicilina, otite, IAM)..." style="flex:1">
    <button id="btn-search" class="primary">Buscar</button>
    <button id="btn-clear">Limpar</button>
    <span class="chip active" data-mode="adulto">Adulto</span>
    <span class="chip" data-mode="pediatria">Pediatria</span>
    <span class="chip" data-mode="gestante">Gestante</span>
  </div>
</section>

<div class="grid" style="margin-top:14px">
  <section class="card" id="results"><div class="mut">Carregando base...</div></section>

  <aside class="card">
    <h3 class="section-title">Calculadoras</h3>
    <div class="pill">Pediatria (mg/kg)</div>
    <div class="row">
      <input id="peso" type="number" step="0.1" placeholder="Peso (kg)">
      <input id="mgkg" type="number" step="0.1" placeholder="mg/kg">
      <input id="freq" type="number" step="1" placeholder="x/dia">
    </div>
    <div class="row" style="margin-top:6px">
      <input id="conc" type="number" step="0.1" placeholder="Concentração (mg/mL ou mg/cp)" style="flex:1">
      <select id="forma"><option value="mL">mL</option><option value="cp">comprimidos</option><option value="gota">gotas (1 gota ≈ 0,05 mL)</option></select>
      <button id="btn-calc" class="primary">Calcular</button>
    </div>
    <pre id="out" class="mut" style="white-space:pre-wrap;margin:8px 0 8px"></pre>

    <div class="pill">TFG (ClCr) – Adulto</div>
    <div class="row">
      <input id="idade" type="number" placeholder="Idade (anos)">
      <input id="pesoA" type="number" step="0.1" placeholder="Peso (kg)">
      <input id="scr" type="number" step="0.01" placeholder="Creatinina (mg/dL)">
      <select id="sexo"><option value="M">Masculino</option><option value="F">Feminino</option></select>
      <button id="btn-tfg" class="primary">Calcular</button>
    </div>
    <div class="mut" id="out-tfg"></div>

    <h3 class="section-title">Interações</h3>
    <div class="row">
      <select id="i-a"></select>
      <select id="i-b"></select>
      <button id="btn-inter">Ver interação</button>
    </div>
    <div id="out-inter" class="mut" style="margin-top:6px"></div>
  </aside>
</div>

<footer class="mut" style="margin-top:16px"><small>Protótipo informativo para profissionais de saúde.</small></footer>
</div>

<script>
let DB={medicamentos:[],patologias:[],protocolos:[],interacoes:[],meta:{}};const state={modo:'adulto',query:''};
function qs(s){return document.querySelector(s)}function el(t,p={},c=[]){const e=document.createElement(t);Object.assign(e,p);c.forEach(x=>e.appendChild(typeof x==='string'?document.createTextNode(x):x));return e}

function render(list){const root=qs('#results');root.innerHTML='';if(!list.length){root.appendChild(el('div',{className:'mut',innerText:'Sem resultados.'}));return;}
  list.forEach(item=>{
    const f=(item.faixas||{})[state.modo]||{};
    const head=el('div',{innerHTML:'<b>'+item.nome+'</b> <span class="mut">'+(item.principioAtivo?('('+item.principioAtivo+')'):'')+'</span>'});
    const dose=el('div',{innerHTML:'<b>Dose:</b> '+(f.dose||f.nota||'-')});
    const max=f.max?el('div',{innerHTML:'<b>Máximo:</b> '+f.max}):null;
    const formas=el('div',{className:'mut',innerText:(item.formas||[]).map(x=>x.apresentacao).join(' • ')});
    const aj=item.tfg_rules?el('div',{className:'mut',innerText:'Ajuste por TFG disponível'}):null;
    const box=el('div',{className:'result'},[head,formas,dose]); if(max) box.appendChild(max); if(aj) box.appendChild(aj);
    root.appendChild(box);
  });}

function search(q){q=(q||'').toLowerCase().trim();state.query=q;
  const meds=DB.medicamentos.filter(m=>(m.nome||'').toLowerCase().includes(q)||(m.principioAtivo||'').toLowerCase().includes(q)||(m.classes||[]).join(' ').toLowerCase().includes(q));
  const pats=DB.patologias.filter(p=>(p.nome||'').toLowerCase().includes(q)).map(p=>({nome:'[Patologia] '+p.nome, principioAtivo:p.categoria||'', formas:[], faixas:{[state.modo]:{nota:(p[state.modo]?.orientacoes)||(p.obs||'Ver opções')}}}));
  const prot=DB.protocolos.filter(pr=>(pr.nome||'').toLowerCase().includes(q)).map(pr=>({nome:'[Protocolo] '+pr.nome, principioAtivo:pr.area||'', formas:[], faixas:{[state.modo]:{nota:(pr.passos?('Passos: '+pr.passos.join(' → ')):'Ver protocolo')}}}));
  render([...pats,...prot,...meds]);
}

function calc(){const peso=parseFloat(qs('#peso').value);const mgkg=parseFloat(qs('#mgkg').value);const freq=parseFloat(qs('#freq').value||1);const conc=parseFloat(qs('#conc').value||0);const forma=qs('#forma').value;
  if(!(peso>0&&mgkg>0)){qs('#out').textContent='Informe peso e mg/kg.';return;}const mg=peso*mgkg;let conv='';if(conc>0){if(forma==='mL')conv=(mg/conc).toFixed(2)+' mL';if(forma==='cp')conv=(mg/conc).toFixed(2)+' comprimidos';if(forma==='gota')conv=((mg/conc)/0.05).toFixed(0)+' gotas';}
  qs('#out').textContent='Dose: '+mg.toFixed(0)+' mg por tomada ('+freq+'x/dia)'+(conv?'\n≈ '+conv:'');}

function cockcroftGault(idade,peso,scr,sexo){let cl=((140-idade)*peso)/(72*scr); if(sexo==='F') cl*=0.85; return cl;}
function showTFG(){const idade=parseFloat(qs('#idade').value);const peso=parseFloat(qs('#pesoA').value);const scr=parseFloat(qs('#scr').value);const sexo=qs('#sexo').value;
  if(!(idade>0&&peso>0&&scr>0)){qs('#out-tfg').textContent='Preencha idade, peso e creatinina.';return;}
  const cl= cockcroftGault(idade,peso,scr,sexo); qs('#out-tfg').textContent='ClCr estimado: '+cl.toFixed(0)+' mL/min';}

function loadInterSelects(){const meds=DB.medicamentos.map(m=>({id:m.id,nome:m.nome}));
  const a=qs('#i-a'), b=qs('#i-b'); [a,b].forEach(sel=>{sel.innerHTML=''; meds.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.nome; sel.appendChild(o);});});}
function checkInter(){const A=qs('#i-a').value, B=qs('#i-b').value; if(A===B){qs('#out-inter').textContent='Selecione fármacos diferentes.';return;}
  const hit = DB.interacoes.find(x=> (x.a===A&&x.b===B)||(x.a===B&&x.b===A)); if(hit){qs('#out-inter').textContent='Gravidade: '+hit.gravidade.toUpperCase()+' — '+hit.descricao;}
  else {qs('#out-inter').textContent='Nenhuma interação relevante catalogada para o par selecionado.';}}

async function autoload(){
  const candidates = [
    "posologiacerta-bundle-v0.10-beta2-BR.json",
    "posologiacerta-bundle-v0.9-beta-BR%20(1).json",
    "posologiacerta-bundle-v0.9-beta-BR.json"
  ];
  let loaded = false;
  for (const url of candidates){
    try{
      const r = await fetch(url, {cache:"no-cache"});
      if(r.ok){
        DB = await r.json();
        qs('#ds').textContent = (DB.meta? (DB.meta.nome+' '+(DB.meta.versao||'')) : '') + ' • '+ (DB.medicamentos?.length||0) +' fármacos';
        loaded = true; break;
      }
    }catch(e){}
  }
  if(!loaded){
    qs('#results').innerHTML = '<div class="mut">Não foi possível carregar o bundle JSON automaticamente. Verifique o nome do arquivo no repositório.</div>';
    return;
  }
  search('');
  loadInterSelects();
}

document.addEventListener('DOMContentLoaded',()=>{
  if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});}
  document.querySelectorAll('.chip[data-mode]').forEach(ch=>{ch.addEventListener('click',()=>{document.querySelectorAll('.chip[data-mode]').forEach(c=>c.classList.remove('active'));ch.classList.add('active');state.modo=ch.dataset.mode;search(state.query);});});
  qs('#btn-search').onclick=()=>search(qs('#q').value); qs('#btn-clear').onclick=()=>{qs('#q').value='';search('')}; qs('#btn-calc').onclick=calc; qs('#btn-tfg').onclick=showTFG;
  let dp=null; window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();dp=e}); qs('#btn-install').onclick=async()=>{if(dp){dp.prompt();dp=null;}else alert('No desktop: Menu do navegador → “Instalar app”.');};
  autoload();
});
</script>
</body></html>
